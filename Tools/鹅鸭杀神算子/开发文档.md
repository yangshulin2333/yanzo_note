**GooseMind 开发白皮书**。

---

# 🦆 GooseMind 项目开发文档 (DevDoc)

**项目名称**: GooseMind

**核心目标**: 基于 AI 视觉与听觉的《Goose Goose Duck (鹅鸭杀)》游戏辅助助手。

**技术栈**: C# (.NET 8/9), WPF, Windows API (User32), HTTP Client, Groq API (Vision/Whisper), DeepSeek API (Reasoning)。

**当前状态**: ✅ 视觉通路已打通 (v0.5.0)

---

## 📅 一、 开发进度总览 (Roadmap)

### 🟢 第一阶段：视觉神经 (Vision) —— **[已完成]**

> **目标**: 让程序能看见游戏画面，并识别出身份和局势。

- [x] **窗口捕获**: 解决 Scrcpy 投屏窗口的查找与截图问题。
    
- [x] **抗遮挡优化**: 使用 `WindowHelper` 句柄截图，解决前台遮挡问题。
    
- [x] **网络穿透**: 解决国内网络无法直连 Groq API 的问题 (配置本地代理)。
    
- [x] **模型接入**: 接入 Llama-3.2/4-Scout Vision 模型。
    
- [x] **提示词工程**: 实现基于 `GamePrompts` 的动态提示词，精准锚定玩家身份。
    

### 🟡 第二阶段：听觉神经 (Hearing) —— **[待开发]**

> **目标**: 监听游戏内的语音交流，转录为文字。

- [ ] **系统内录**: 引入 `NAudio` 或 `CoreAudioApi` 捕获扬声器声音。
    
- [ ] **VAD (语音活动检测)**: 识别有人说话的片段，避免静音上传浪费 Token。
    
- [ ] **API 对接**: 对接 Groq Whisper 模型进行 STT (语音转文字)。
    
- [ ] **声纹区分 (难点)**: (可选) 尝试区分是“谁”在说话。
    

### 🟡 第三阶段：大脑中枢 (Brain) —— **[待开发]**

> **目标**: 结合看到的和听到的，进行逻辑推理并给出建议。

- [ ] **信息汇总**: 将视觉结果(身份/存活) + 听觉结果(聊天内容) 打包。
    
- [ ] **DeepSeek 接入**: 对接 DeepSeek-V3/R1 接口。
    
- [ ] **策略生成**: 让 AI 给出行动建议（如：“去验一下红鸭子”、“假装做任务”）。
    
- [ ] **短时记忆**: 维护一个简单的上下文列表，让 AI 记得上一轮发生了什么。
    

### 🔴 第四阶段：自动化与交互 (Automation & UI) —— **[待开发]**

> **目标**: 从“手动点击”变为“全自动辅助”。

- [ ] **心跳循环**: 建立 `Timer` 循环，每隔 5-10 秒自动执行一次“看-想-说”。
    
- [ ] **透明浮窗**: 抛弃 MessageBox，使用 WPF 透明置顶窗口将建议直接显示在游戏画面上。
    
- [ ] **状态面板**: 可视化显示 Token 消耗、API 延迟、当前身份。
    

---

## 🛠️ 二、 核心模块详解 (已完成部分)

### 1. 基础设施配置 (`AppConfig.cs`)

集中管理所有常量，实现低耦合。

- **API 配置**: 分离了 `Speech` (Groq), `Brain` (DeepSeek), `Vision` (Groq) 的 Key 和 URL。
    
- **身份锚定**:
    
    - `TargetWindowTitle`: "25032RP42C" (通过窗口标题精准查找，避免混淆 CMD 窗口)。
        
    - `MyGameName`: "六六混瑶子" (用于 AI 在截图中定位玩家行)。
        
- **模型选择**: 视觉模型已更新为 `meta-llama/llama-4-scout-17b-16e-instruct`。
    

### 2. 窗口操作工具 (`Services/WindowHelper.cs`)

封装底层 Windows API (`User32.dll`)。

- **`GetHandleByTitle(string title)`**: 使用 `FindWindow` 精准查找游戏窗口句柄。
    
- **`GetWindowBounds(IntPtr handle)`**: 获取窗口当前的屏幕坐标和尺寸。
    
- **`CaptureWindow(IntPtr handle)`**:
    
    - 原理: 使用 `PrintWindow` API。
        
    - 优势: 支持后台截图（部分）、支持被其他窗口遮挡时依然能截取到画面。
        
    - _注意_: Scrcpy 最小化时会导致黑屏（GPU 停止渲染），需保持窗口在桌面（可被遮挡但不可最小化）。
        

### 3. 视觉服务 (`Services/VisionService.cs`)

纯工具类，负责数据格式转换。

- **`ImageToBase64(Bitmap bmp)`**: 将 C# 的 Bitmap 对象转换为 Web API 所需的 Base64 字符串。
    
- **`CaptureScreen`**: (已废弃) 旧的屏幕截取方法，因会被遮挡而不再使用。
    

### 4. Groq 视觉通信 (`Services/GroqVisionService.cs`)

**核心通信模块**，解决了国内网络环境问题。

- **静态构造**: 程序启动时初始化 `HttpClient`。
    
- **本地代理 (Proxy)**:
    
    - 硬编码代理地址: `http://127.0.0.1:10808` (对应 v2rayN 本地监听端口)。
        
    - 原理: C# HTTP 请求 -> 本地 10808 端口 -> v2rayN 加密 -> 境外 VPS -> Groq 服务器。
        
    - **关键点**: 必须使用 `HttpClientHandler` 并设置 `UseProxy = true`。
        
- **JSON 协议**: 构造符合 OpenAI 格式的多模态 Payload (Image URL + Text)。
    

### 5. 提示词工程 (`GamePrompts.cs`)

将“业务逻辑”与“代码逻辑”分离。

- 使用 C# 字符串插值 `{0}` 动态填入玩家名字。
    
- **当前 Prompt 策略**:
    
    1. 寻找包含 `{AppConfig.MyGameName}` 的名字。
        
    2. 寻找黄色高亮框。
        
    3. OCR 读取职业名称。
        
    4. 分析游戏阶段（倒计时/状态文本）。
        

---

## 📝 三、 下一步开发任务清单 (To-Do List)

你需要按照以下顺序进行开发：

### 任务 1: 引入音频库 (听觉准备)

- [ ] 在 NuGet 安装 `NAudio`。
    
- [ ] 编写 `AudioService.cs`，实现 `LoopbackCapture` (声卡内录)。
    
- [ ] 测试能否录制到系统声音并保存为 `.wav` 文件。
    

### 任务 2: 打通 DeepSeek 大脑

- [ ] 完善 `ApiService.cs` (目前可能还是空的或旧的)。
    
- [ ] 确保 `ApiService` 不需要代理 (国内直连) 或配置正确的路由。
    
- [ ] 编写测试方法：发送简单的文本 "你好"，确认 DeepSeek 能回复。
    

### 任务 3: 构建“游戏上下文”对象

- [ ] 创建 `GameContext` 类，用于存储：
    
    - 当前身份 (Identity)
        
    - 当前存活玩家列表 (AlivePlayers)
        
    - 上一轮的对话摘要 (LastSummary)
        
- [ ] 将 Vision 的结果解析后存入这个对象，而不是直接弹窗。
    

### 任务 4: UI 改造 (浮窗化)

- [ ] 新建 `OverlayWindow.xaml`。
    
- [ ] 设置属性: `WindowStyle="None"`, `AllowsTransparency="True"`, `Topmost="True"`, `Background="Transparent"`。
    
- [ ] 实现文字描边效果（防止在浅色游戏背景上看不清字）。
    

---

## ⚠️ 常见问题与注意事项 (Troubleshooting)

1. **截图全黑**:
    
    - 原因: scrcpy 窗口被最小化了。
        
    - 解决: 保持窗口还原状态，可以被其他窗口挡住，但不能点任务栏的最小化。
        
2. **API 报错 (Bad Request / Model Decommissioned)**:
    
    - 原因: Groq 模型更新极快。
        
    - 解决: 检查 `AppConfig.VisionModel` 是否为最新 (目前是 Llama-4-Scout)。
        
3. **API 报错 (Timeout / Connection Refused)**:
    
    - 原因: 代理未生效或端口变了。
        
    - 解决: 检查 v2rayN 左下角端口是否仍为 `10808`，检查 `GroqVisionService.cs` 里的端口设置。
        
4. **找不到窗口**:
    
    - 原因: 手机断开连接，或 scrcpy 标题变了。
        
    - 解决: 重新确认 `AppConfig.TargetWindowTitle` 与实际窗口标题完全一致（区分大小写）。